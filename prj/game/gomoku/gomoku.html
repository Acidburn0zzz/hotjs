<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Expires" CONTENT="0">
<meta http-equiv="Cache-Control" CONTENT="no-cache">
<meta http-equiv="Pragma" CONTENT="no-cache">
<link rel="apple-touch-icon" href="img/icon.png" />
<link rel="icon" type="image/png" href="img/icon.png" />
<link rel="stylesheet" href="gomoku.css">
<meta name="viewport"
	content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />

<script src="../../lib/jquery-1.9.js"></script>

<script src="../../../hotjs/hotjs.js"></script>
<script src="../../../hotjs/resource.js"></script>
<script src="../../../hotjs/math.js"></script>
<script src="../../../hotjs/canvas.js"></script>
<script src="../../../hotjs/social.js"></script>

<script src="goboard.js"></script>
<script src="net_go.js"></script>

<style type="text/css">

</style>
</head>
<body>
<div>
<div id="mainView"></div>

<div id="user1">
<table>
<tr><td align='left' colspan=2>级别: 6<br>金币: $ 1500</td></tr>
<tr><td><img src='img/user1.png'><br>曹操</td><td><img width=32 src='img/whitego.png'/></td></tr>
</table>
</div>

<div id="user2">
<table>
<tr><td align='left' colspan=2>级别: 7<br>金币: $ 2100</td></tr>
<tr><td><img width=32 src='img/blackgo.png'/></td><td><img src='img/user2.png'><br>刘备</td></tr>
</table>
</div>

<div id="control">
<table>
<tr><td><img width=32 src='img/undo.png' onClick='board.undo();'/><br>悔棋</td></tr>
<tr><td><img width=32 src='img/tips.png' onClick=''/><br>提示</td></tr>
</table>
</div>

<div id='menu'>
<table>
<tr>
<td class='m'><img width=32 src='img/menu.png'/><br>菜单</td>
<td class='m'><img width=32 src='img/games.png'/><br>微游</td>
<td class='m'><img width=32 src='img/msg.png'/><br>聊天</td>
<td class='m'><img width=32 src='img/friends.png'/><br>朋友们</td>
<td class='m'><img width=32 src='img/settings.png'/><br>设置</td>
</tr></table>
</div>

</div>
<script>

//var api_url = "http://cloud.rnjsoft.com/sns/gomoku/api.inf";
var api_url = '../../sns/gomoku/api.inf';

var viewX;
var board;
var net_go;

var worker = new Worker('ai_go.js');

worker.onmessage = function(evt) {
	var msg = evt.data;
	console.log( 'main received: ', msg.api, msg );
	
	switch(msg.api) {
	case 'confirmColor':
		var c = (msg.color == 2) ? 1 : 2;
		board.confirmColor( c );	
		break;
	case 'go':
		var s = msg.solution;
		board.setTip( s );

		var bestMove = s.bestMove;
		console.log( bestMove.x, bestMove.y );
		board.go( bestMove.x, bestMove.y );
		break;
	case 'undo':
		break;
	}
}

var AIPlayer = function(){
	hotjs.base(this);
	
	this.mycolor = 2;
};

hotjs.inherit(AIPlayer, hotjs.Class, {
	setPeerColor : function(c) {
		work.postMessage({
			api: 'setColor',
			color: c
		});
	},
	go : function( move, mtx_str) {
		worker.postMessage({
			api: 'go',
			move: {
				x: move[0],
				y: move[1],
				color:move[2]
			},
			matrix_str: mtx_str
		});
	},
	undo : function( move, mtx_str) {
		worker.postMessage({
			api: 'undo',
			move: {
				x: move[0],
				y: move[1],
				color:move[2]
			},
			matrix_str: mtx_str
		});
	}
});

function main() {
	var w = window.innerWidth, h = window.innerHeight;
	h -= $("#menu").height();
	
	var m = Math.min(w,h);
	
	var v = document.getElementById('mainView');
	v.style.width = w;
	v.style.height = h;
	
	if( h > w ) {
		var btn_w = w / 4;
		var btn_h = (h-m)/2 / 7;
		$(".btn").css('font-size', btn_h + 'pt');
	} else {
		
	}
	
	viewX = (new hotjs.View())
		.setContainer('mainView')
		.setSize(w,h)
		.showFPS(false);

	board = (new GoBoard(19))
		.setSize(w, h)
		.setColor("black").showGrid(false)
		.setBgImage( true, resources.get('img/woodfloor.jpg') )
		.setAreaImage( true, resources.get('img/wood.jpg') )
		.setGoImage( resources.get('img/gostones.png'), [0,0,128,128] )
		.showImg(true)
		.setDraggable(true).setMoveable(true).setZoomable(true)
		.resetGame()
		.addTo( viewX );
	
	board.setPeerPlayer( new AIPlayer() );
	
	var app = (new hotjs.App())
		.addNode(viewX)
		.start();
	
}

resources.load([
                'img/woodfloor.jpg',
                'img/wood.jpg',
                'img/gostones.png',
                'audio/move.mp3'
        	]);

resources.onReady( main );

</script>
</body>

</html>
