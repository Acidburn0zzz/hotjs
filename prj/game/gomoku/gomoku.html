<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Expires" CONTENT="0">
<meta http-equiv="Cache-Control" CONTENT="no-cache">
<meta http-equiv="Pragma" CONTENT="no-cache">
<link rel="apple-touch-icon" href="img/icon.png" />
<link rel="icon" type="image/png" href="img/icon.png" />
<link rel="stylesheet" href="gomoku.css">
<meta name="viewport"
	content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />

<script src="../../lib/jquery-1.9.js"></script>

<script src="../../../hotjs/hotjs.js"></script>
<script src="../../../hotjs/resource.js"></script>
<script src="../../../hotjs/math.js"></script>
<script src="../../../hotjs/canvas.js"></script>
<script src="../../../hotjs/social.js"></script>

<script src="goboard.js"></script>
<script src="net_go.js"></script>

<style type="text/css">

</style>
</head>
<body>
<div>
<div id="mainView"></div>

<div id="user1" style='display:none;'>
<table>
<tr><td align='left' colspan=2>级别: 6<br>财富: $ 1500</td></tr>
<tr><td><img src='img/user1.png'><br>曹操</td><td><img width=32 src='img/whitego.png'/></td></tr>
</table>
</div>

<div id="user2" style='display:none;'>
<table>
<tr><td align='left' colspan=2>级别: 7<br>财富: $ 2100</td></tr>
<tr><td><img width=32 src='img/blackgo.png'/></td><td><img src='img/user2.png'><br>刘备</td></tr>
</table>
</div>

<div id="control" style='display:none;'>
<table>
<tr><td><img width=48 class='menu-icon' src='img/restart.png' onClick='board.resetGame();'/><br>新局</td></tr>
<tr><td><img width=48 class='menu-icon' src='img/undo.png' onClick='board.undo();'/><br>悔棋</td></tr>
<tr><td><img width=48 class='menu-icon icon-tip' src='img/tipoff.png'/><br>提示</td></tr>
</table>
</div>

<div id='menu' style='display:block;'>
<table>
<tr>
<td class='m'><img width=48 class='menu-icon' src='img/restart.png' onClick='board.resetGame();'/><br>新局</td>
<td class='m'><img width=48 class='menu-icon' src='img/undo.png' onClick='board.undo();'/><br>悔棋</td>
<td class='m'><img width=48 class='menu-icon icon-tip' src='img/tipoff.png'/><br>提示</td>
<td class='m'><img width=48 class='menu-icon' src='img/settings.png'/><br>设置</td>
<td class='m'><img width=48 class='menu-icon' src='img/menu.png'/><br>更多...</td>
</tr></table>
</div>

<div id='menuX' style='display:none;'>
<table>
<tr>
<td class='m'><img width=48 src='img/menu.png'/><br>菜单</td>
<td class='m'><img width=48 src='img/games.png'/><br>微游</td>
<td class='m'><img width=48 src='img/msg.png'/><br>聊天</td>
<td class='m'><img width=48 src='img/friends.png'/><br>朋友们</td>
<td class='m'><img width=48 src='img/settings.png'/><br>设置</td>
</tr></table>
</div>

</div>
<script>

$('.icon-tip').on('click', function(){
	board.showTip();
	if( board.getTipStatus() ) {
		$('.icon-tip').attr('src', "img/tipon.png");
	} else {
		$('.icon-tip').attr('src', "img/tipoff.png");
	}
});

$('.menu-icon').on('mousedown', function(){
	resources.get('audio/click.mp3').play();
});

//var api_url = "http://cloud.rnjsoft.com/sns/gomoku/api.inf";
var api_url = '../../sns/gomoku/api.inf';

var viewX;
var board;
var ai_player;
var net_player;

var worker = new Worker('ai_go.js');

worker.onmessage = function(evt) {
	var msg = evt.data;
	//console.log( 'main received: ', msg.api, msg );
	
	switch(msg.api) {
	case 'confirmColor':
		var c = (msg.color == 2) ? 1 : 2;
		board.confirmColor( c );	
		break;
	case 'judge':
		var s = msg.solution;
		board.setTip( s );
		if( s.myWinHits.length > 0 ) {
			//console.log( ai_player.mycolor + ' win', s.myWinHits );	
			//console.log( 'Computer win!' );
			board.gameOver = true;
			resources.get('audio/magic.mp3').play();
		}
		if ( s.peerWinHits.length > 0 ) {
			//console.log( board.hostColor + ' win', s.peerWinHits );
			//console.log( 'You win! ' );
			board.gameOver = true;
			resources.get('audio/magic.mp3').play();
		}
		break;
	case 'go':
		var s = msg.solution;
		var bestMove = s.bestMove;
		setTimeout(function(){
			if( ! board.gameOver ) {
				board.go( bestMove.x, bestMove.y );
			}
		}, 500);
		break;
	case 'undo':
		var s = msg.solution;
		board.setTip( s );

		var bestMove = s.bestMove;
		console.log( bestMove );
		
		break;
	}
}

var AIPlayer = function(){
	hotjs.base(this);
	
	this.mycolor = 2;
};

hotjs.inherit(AIPlayer, hotjs.Class, {
	setPeerColor : function(c) {
		work.postMessage({
			api: 'setColor',
			color: c
		});
	},
	judge : function( mtx_str) {
		worker.postMessage({
			api: 'judge',
			matrix_str: mtx_str
		});
	},
	go : function( move, mtx_str) {
		worker.postMessage({
			api: 'go',
			move: {
				x: move[0],
				y: move[1],
				color:move[2]
			},
			matrix_str: mtx_str
		});
	},
	undo : function( move, mtx_str) {
		worker.postMessage({
			api: 'undo',
			move: {
				x: move[0],
				y: move[1],
				color:move[2]
			},
			matrix_str: mtx_str
		});
	}
});

ai_player = new AIPlayer();

function main() {
	resources.get('audio/magic.mp3').play();
	
	var w = window.innerWidth, h = window.innerHeight;
	h -= $("#menu").height();
	
	var m = Math.min(w,h);
	
	var v = document.getElementById('mainView');
	v.style.width = w;
	v.style.height = h;
	
	viewX = (new hotjs.View())
		.setContainer('mainView')
		.setSize(w,h)
		.showFPS(false);

	board = (new GoBoard(15))
		.setSize(w, h)
		.setColor("black").showGrid(false)
		.setBgImage( true, resources.get('img/woodfloor.jpg') )
		.setAreaImage( true, resources.get('img/wood.jpg') )
		.setGoImage( resources.get('img/gostones.png'), [0,0,128,128] )
		.showImg(true)
		.setDraggable(true).setMoveable(true).setZoomable(true)
		.resetGame()
		.addTo( viewX );
	
	board.setPeerPlayer( ai_player );
	
	var app = (new hotjs.App())
		.addNode(viewX)
		.start();
	
}

$(window).resize(function(){
	var w = window.innerWidth, h = window.innerHeight;
	h -= $("#menu").height();
	var m = Math.min(w, h);
	
	viewX.setSize(w,h);

	board.setSize(w,h).setArea( (w-m)/2, (h-m)/2, m, m );
});

resources.load([
                'img/woodfloor.jpg',
                'img/wood.jpg',
                'img/gostones.png'
                //, 'audio/move.mp3'
        	]);

resources.onReady( main );

</script>
</body>

</html>
