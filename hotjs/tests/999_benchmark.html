<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Expires" CONTENT="0">
<meta http-equiv="Cache-Control" CONTENT="no-cache">
<meta http-equiv="Pragma" CONTENT="no-cache">
<meta name="viewport"
	content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
<script type="text/javascript" src="../resource.js"></script>
<script type="text/javascript" src="../sprite.js"></script>
<script type="text/javascript" src="../hotjs.js"></script>
<script type="text/javascript" src="../math.js"></script>
<script type="text/javascript" src="../physics.js"></script>
<style type="text/css">
html, body {
	width: 100%;
	height: 100%;
	overflow: hidden;
	margin: 0;
	padding: 0;
}
div#mainView {
	display: inline-block;
	border: solid green 0px;
	margin: 0px;
	padding: 0px;
}
div#btn_zoom {
	display: inline-block;
	position: absolute;
	border: solid green 1px;
	margin: 0px;
	padding: 0px;
	top: 10px;
	right: 10px;
	background-color: #eeeeee;
}
div#btn_act {
	display: inline-block;
	position: absolute;
	border: solid green 1px;
	margin: 0px;
	padding: 0px;
	top: 50px;
	right: 10px;
	background-color: #eeeeee;
}
input.act {
	right: 0px;
}
</style>
</head>
<body>
<div>
<div id="mainView"></div>
<div id="btn_zoom">
<input type='button' value='?' onClick='viewX.showFPS()'/>
<input type='button' value='#' onClick='room.showGrid();room.showBgImg();'/>
<input type='button' value='f' onClick='room.showFormula()'/>
<input type='button' value='start' onClick='room.benchFPS(1,500)'/>
<input type='button' value='stop' onClick='room.benchStop()'/>
</div>
</div>
<script>
	
var BenchLab = function(){
	hotjs.base(this);
	this.formula = false;

	this.nMin = 1;
	this.nMax = 500;
	this.fpsData = [];
	
	this.dtSum = 0;
	this.nCur = this.nMax;
};

var PAD = 40;

hotjs.inherit(BenchLab, hotjs.Physics.Scene, {
	showFormula : function(f) {
		if(f == undefined) f = (! this.formula);
		this.formula = f;
		return this;
	},
	benchFPS: function(min, max) {
		this.nMin = min;
		this.nMax = max;
		this.fpsData = [];
		
		this.dtSum = 0;
		this.nCur = this.nMin;
		this.subnodes.length = 0;
		
		return true;
	},
	benchStop : function() {
		this.nCur = this.nMax;

		this.subnodes.length = 0;
		this.showGrid(false);
		this.showBgImg(false);
		this.container.showFPS(false);
		
		return true;
	},
	update : function(dt) {
		BenchLab.supClass.update.call(this, dt);
		
		if( this.nCur < this.nMax ) {
			this.dtSum += dt;
			if( this.dtSum >= 200 ) {
				this.dtSum = 0;
				
				this.addBall();
				this.nCur ++;
				
				var f = (this.height()-PAD*2) / 60;
				this.fpsData.push( f * this.container.fps );
			}
		}
		
		return true;
	},
	addBall : function() {
		var rmax = 30;
		var vmax = this.width()/60;
		var r = hotjs.Random.Integer(20,rmax);
		var x = PAD; //hotjs.Random.Integer(rmax, this.width()-rmax);
		var y = PAD; // hotjs.Random.Integer(rmax, this.height()-rmax);
		var vx = hotjs.Random.Float(0, vmax);
		var vy = hotjs.Random.Float(0, vmax/2);
		
		var b = new hotjs.Physics.Ball();
		b.setImage(resources.get('redball.png')).setSize(r,r).setDensity(1);
		//b.setDraggable(true).setMoveable(true);
		
		b.setPos(x, y).setVelocity(vx,vy).setAccel(0,0);
		this.addNode(b);
		
		return this;
	},
	removeAllBalls : function(){
		this.subnodes.length = 0;
		return this;
	},
	drawFormula : function(c) {
		c.save();
		
		// draw x, y axis 
		var x0 = PAD, y0 = this.height() -PAD;
		
		c.beginPath();
		c.strokeStyle = "black";
		c.fillStyle = "black";
		c.moveTo(x0,PAD); c.lineTo(x0,y0); c.lineTo(this.width()-PAD, y0);
		c.fillText( "60 fps", x0-20, PAD-10 );
		c.fillText( "" + this.nMax, this.width()-PAD-20, y0+20 );
		c.stroke();
		
		// draw graph
		c.beginPath();
		c.strokeStyle = "red";
		var f = (this.width()-PAD*2) / (this.nMax-this.nMin);
		if( this.fpsData.length >0 ) {
			c.moveTo( x0, y0-this.fpsData[0] );
		}
		for( var i=1; i<this.fpsData.length; i++) {
			c.lineTo( x0 + i * f, y0-this.fpsData[i] );
		}
		c.stroke();
		
		c.restore();		
	},
	draw : function(c) {
		BenchLab.supClass.draw.call(this, c);

		if( this.formula ) this.drawFormula(c);
	}		
});

var balls = [];
var add_ball = function(){};
var remove_ball = function(){};

var viewX;
var room;

resources.load([
    		'redball.png',
    		'smallbird.png',
    		'room.jpg'
    	]);
        	
resources.onReady(function() {
	var w = window.innerWidth, h = window.innerHeight;
	
	var v = document.getElementById('mainView');
	v.style.width = w;
	v.style.height = h;

	viewX = (new hotjs.View()).setContainer('mainView').setSize(w,h).showFPS(true);

	room = (new BenchLab()).setSize(w, h).setColor("blue");
	room.setImage(resources.get('room.jpg')).showGrid(true).showBgImg(true).showFormula(true);
	viewX.addScene(room);
	
	var app = (new hotjs.App()).addView(viewX).start();
});
</script>
</body>

</html>
